rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow authenticated users to read and write their own user profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow authenticated users to read and write their own game sessions
    match /gameSessions/{sessionId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid in resource.data.players || 
         request.auth.uid in request.resource.data.players);
    }
    
    // Allow authenticated users to read leaderboard data
    match /leaderboard/{document=**} {
      allow read: if request.auth != null;
    }
    
    // Allow authenticated users to read and write matchmaking queue
    match /matchmaking/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // Allow authenticated users to read and write duel sessions
    match /duels/{duelId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (request.auth.uid == request.resource.data.player1Id || 
         request.auth.uid == request.resource.data.player2Id ||
         request.auth.uid == resource.data.player1Id || 
         request.auth.uid == resource.data.player2Id);
    }
    
    // Allow authenticated users to read and write their training progress
    match /training/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow all authenticated users to read quiz questions (for fallback mode)
    match /quizzes/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null; // Allow creating quiz sessions
    }
  }
}
